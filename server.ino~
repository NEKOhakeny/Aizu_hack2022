#include <WiFi.h>
#include <WebServer.h>

const char* ssid     = "rx600m-bf5de4-1";
const char* password = "2fc8ecf29924b";

const int LED=5;
bool flg=HIGH;

WebServer server(80);
String html;
bool locked;

void mainPage() 
{
  Serial.println("mainPage on");
  html = "<!DOCTYPE html>\n<html lang \"ja\">\n<head>\n<meta charset = \"utf-8\"><meta charset=\"utf-8\">\n  <title>オートロック管理システム</title>\n</head>\n\n<body>\n  <form action=\"#\" method=\"post\">\n    パスワード：<br>\n    <input type=\"text\" name=\"password\" id=\"Pass\">\n    <input type=\"button\" value=\"確認する\" id=\"Conf\" oncick=Make_body(this.id);></p>\n    <script>\n      const post = (path, body) => {\n        const request = new \nMLHttpRequest();\n        request.open(\'POST\', path, false);\n        request.setRequestHeader(\"Content-Type\", \"text/plain\");\n        request.send(body);\n        if (request.status === 200) {\n          alert(\'リクエストに成功しました\');\n          return JSON.parse(request.responseText);\n        } else {\n          alert(\'リクエストに失敗しました\');\n          return 0;\n        }\n      }\n      const pass = document.getElementId(\"Pass\");\n      const path = \"192.168.1.4:80\";\n      const Make_body = () => {\n        const body = pass.value;\n        post(path, pass.value);\n        if (post == 0) console.log(pass.value);\n      }\n    </script>\n</body>\n</form>\n</html>";
  server.send(200,"text/html",html);
  
}
void mainPage_2()
{
  Serial.println("main_page2 on");
  html = "";
  server.send(200,"text/html",html);
}
void sendState()
{
  if(locked)
  {
    //
  }
  else
  {
    //
  }
}

void lock()
{
  if(locked)return ;
  //
  locked = true;
  mainPage_2();  
}
void unlock()
{
  if(!locked)return ;
  //
  locked = false;
  mainPage_2();
}

void setup(void) 
{
  pinMode(LED,OUTPUT);
  Serial.begin(115200);
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) 
  {
    delay(500);
    Serial.print(".");
  }

  Serial.println("");
  Serial.print("Connected to ");
  Serial.println(ssid);
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());
  server.on("/", mainPage);
  server.on("/confirm",sendState);
  server.on("/lock",lock);
  server.on("/unlock",unlock);
  server.begin();
}

void loop(void) 
{
  server.handleClient();
  String pass = server.arg('plain');
}
